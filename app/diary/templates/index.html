<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ ì¼ê¸°ì¥ - Overmind</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 24px;
            color: #333;
        }
        .user-menu {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #5568d3;
        }
        .btn-secondary {
            background: #95a5a6;
        }
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        @media (min-width: 768px) {
            .container {
                grid-template-columns: 350px 1fr;
            }
        }
        @media (min-width: 1024px) {
            .container {
                grid-template-columns: 400px 1fr;
            }
        }
        .calendar-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .calendar-header h2 {
            font-size: 18px;
            color: #333;
        }
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        .calendar-nav button {
            background: #f0f0f0;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .calendar-nav button:hover {
            background: #e0e0e0;
        }
        .calendar {
            width: 100%;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: #666;
            padding: 10px 0;
            font-size: 14px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            font-size: 14px;
        }
        .calendar-day:hover {
            background: #f0f0f0;
        }
        .calendar-day.other-month {
            color: #ccc;
        }
        .calendar-day.today {
            background: #e3f2fd;
            font-weight: 600;
        }
        .calendar-day.selected {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        .calendar-day.has-diary::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 4px;
            height: 4px;
            background: #667eea;
            border-radius: 50%;
        }
        .calendar-day.selected.has-diary::after {
            background: white;
        }
        .diary-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        .diary-date {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .no-diary {
            text-align: center;
            padding: 80px 20px;
        }
        .no-diary p {
            color: #999;
            font-size: 16px;
            margin-bottom: 30px;
        }
        .btn-large {
            padding: 15px 40px;
            font-size: 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-large:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .diary-content {
            line-height: 1.8;
            color: #333;
            font-size: 15px;
        }
        .diary-meta {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ğŸ“” ë‚˜ì˜ ì¼ê¸°ì¥</h1>
            <div class="user-menu">
                <span id="userEmail" style="color: #666; font-size: 14px;"></span>
                <a href="/auth/me" class="btn btn-secondary">ë§ˆì´í˜ì´ì§€</a>
                <button onclick="logout()" class="btn btn-secondary">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ë‹¬ë ¥ ì„¹ì…˜ -->
        <div class="calendar-section">
            <div class="calendar-header">
                <h2 id="calendarTitle"></h2>
                <div class="calendar-nav">
                    <button onclick="changeMonth(-1)">â—€</button>
                    <button onclick="changeMonth(1)">â–¶</button>
                </div>
            </div>
            <div class="calendar">
                <div class="calendar-grid">
                    <div class="calendar-day-header">ì¼</div>
                    <div class="calendar-day-header">ì›”</div>
                    <div class="calendar-day-header">í™”</div>
                    <div class="calendar-day-header">ìˆ˜</div>
                    <div class="calendar-day-header">ëª©</div>
                    <div class="calendar-day-header">ê¸ˆ</div>
                    <div class="calendar-day-header">í† </div>
                </div>
                <div class="calendar-grid" id="calendarDays"></div>
            </div>
        </div>

        <!-- ì¼ê¸° ì„¹ì…˜ -->
        <div class="diary-section">
            <div class="diary-date" id="selectedDate"></div>
            <div id="diaryContent">
                <div class="loading">ë‹¬ë ¥ì—ì„œ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('access_token');

        // Check if logged in
        if (!token) {
            window.location.href = '/auth/login';
        }

        // Helper function to convert Date to local YYYY-MM-DD string
        function toLocalISODate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let selectedDate = new Date();
        let diariesWithEntries = new Set(); // ì¼ê¸°ê°€ ìˆëŠ” ë‚ ì§œë“¤

        // Load user info
        async function loadUserInfo() {
            try {
                const res = await fetch('/auth/api/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const user = await res.json();
                    document.getElementById('userEmail').textContent = user.email;
                } else {
                    window.location.href = '/auth/login';
                }
            } catch (error) {
                console.error('Error loading user:', error);
                window.location.href = '/auth/login';
            }
        }

        // Load diaries for current month
        async function loadDiariesForMonth() {
            try {
                const startDate = new Date(currentYear, currentMonth, 1);
                const endDate = new Date(currentYear, currentMonth + 1, 0);
                const startStr = toLocalISODate(startDate);
                const endStr = toLocalISODate(endDate);

                const res = await fetch(`/diary/api/diaries?start_date=${startStr}&end_date=${endStr}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    diariesWithEntries.clear();
                    data.entries.forEach(diary => {
                        diariesWithEntries.add(diary.entry_date);
                    });
                }
            } catch (error) {
                console.error('Error loading diaries:', error);
            }
        }

        // ìƒˆë¡œìš´ í•¨ìˆ˜: ì¼ê¸° ë§ˆì»¤ë¥¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
        async function updateDiaryMarkers() {
            await loadDiariesForMonth();
            diariesWithEntries.forEach(dateStr => {
                const dayElement = document.querySelector(`.calendar-day[data-date="${dateStr}"]`);
                if (dayElement) {
                    dayElement.classList.add('has-diary');
                }
            });
        }

        // Render calendar
        function renderCalendar() {
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const prevLastDay = new Date(currentYear, currentMonth, 0);

            const firstDayOfWeek = firstDay.getDay();
            const lastDate = lastDay.getDate();
            const prevLastDate = prevLastDay.getDate();

            document.getElementById('calendarTitle').textContent =
                `${currentYear}ë…„ ${currentMonth + 1}ì›”`;

            let days = '';

            // Previous month days
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = prevLastDate - i;
                days += `<div class="calendar-day other-month">${day}</div>`;
            }

            // Current month days
            const today = new Date();
            for (let i = 1; i <= lastDate; i++) {
                const date = new Date(currentYear, currentMonth, i);
                const dateStr = toLocalISODate(date);

                let classes = 'calendar-day';
                if (date.toDateString() === today.toDateString()) classes += ' today';
                if (date.toDateString() === selectedDate.toDateString()) classes += ' selected';

                // data-date ì†ì„± ì¶”ê°€
                days += `<div class="${classes}" data-date="${dateStr}" onclick="selectDate(${i})">${i}</div>`;
            }

            // Next month days
            const remainingDays = 42 - (firstDayOfWeek + lastDate);
            for (let i = 1; i <= remainingDays; i++) {
                days += `<div class="calendar-day other-month">${i}</div>`;
            }

            document.getElementById('calendarDays').innerHTML = days;

            // ë Œë”ë§ í›„ ë§ˆì»¤ ì—…ë°ì´íŠ¸
            updateDiaryMarkers();
        }

        // Select date
        async function selectDate(day) {
            selectedDate = new Date(currentYear, currentMonth, day);
            renderCalendar();
            await loadDiaryForDate();
        }

        // Change month
        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        // Load diary for selected date
        async function loadDiaryForDate() {
            const dateStr = toLocalISODate(selectedDate);
            document.getElementById('selectedDate').textContent =
                `${selectedDate.getFullYear()}ë…„ ${selectedDate.getMonth() + 1}ì›” ${selectedDate.getDate()}ì¼`;

            document.getElementById('diaryContent').innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';

            try {
                const res = await fetch(`/diary/api/diaries/date/${dateStr}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const diary = await res.json();

                    // nullì´ë©´ ì¼ê¸°ê°€ ì—†ëŠ” ê²ƒ (ì •ìƒ)
                    if (diary === null) {
                        displayNoDiary();
                    } else {
                        displayDiary(diary);
                    }
                } else {
                    // ì—ëŸ¬ ì²˜ë¦¬
                    const error = await res.json();
                    console.error('API Error:', error);

                    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                    let errorMessage = 'ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';

                    if (error.detail && error.detail.message) {
                        // ì„œë²„ì—ì„œ ì œê³µí•œ í•œê¸€ ë©”ì‹œì§€ ì‚¬ìš©
                        errorMessage = error.detail.message;
                    }

                    // íŠ¹ì • ì—ëŸ¬ ì½”ë“œë³„ ì²˜ë¦¬
                    if (error.detail && error.detail.error_code) {
                        const errorCode = error.detail.error_code;

                        if (errorCode === 'AUTH_1006' || errorCode === 'AUTH_1005') {
                            // í† í° ë§Œë£Œ ë˜ëŠ” ìœ íš¨í•˜ì§€ ì•ŠìŒ
                            alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                            logout();
                            return;
                        } else if (errorCode.startsWith('AI_5')) {
                            // AI ì„œë¹„ìŠ¤ ì—ëŸ¬ëŠ” ì¬ì‹œë„ ì•ˆë‚´
                            errorMessage += ' ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                        }
                    }

                    document.getElementById('diaryContent').innerHTML =
                        `<div class="loading">${errorMessage}</div>`;
                }
            } catch (error) {
                console.error('Network error:', error);
                document.getElementById('diaryContent').innerHTML =
                    '<div class="loading">ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
            }
        }

        // Display diary
        function displayDiary(diary) {
            let content = '';

            if (diary.mood || diary.summary) {
                content += '<div class="diary-meta">';
                if (diary.mood) {
                    content += `<div>ê¸°ë¶„: ${diary.mood}</div>`;
                }
                if (diary.summary) {
                    content += `<div>ìš”ì•½: ${diary.summary}</div>`;
                }
                content += '</div>';
            }

            content += `<div class="diary-content">${diary.content.replace(/\n/g, '<br>')}</div>`;

            document.getElementById('diaryContent').innerHTML = content;
        }

        // Display no diary
        function displayNoDiary() {
            const dateStr = toLocalISODate(selectedDate);
            document.getElementById('diaryContent').innerHTML = `
                <div class="no-diary">
                    <p>ğŸ“ ì´ ë‚ ì˜ ì¼ê¸°ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤</p>
                    <button class="btn-large" onclick="location.href='/diary/write?date=${dateStr}'">
                        ì¼ê¸° ì‘ì„±í•˜ê¸°
                    </button>
                </div>
            `;
        }

        // Logout
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            window.location.href = '/auth/login';
        }

        // Initialize
        loadUserInfo();
        renderCalendar();
        // ì´ˆê¸° ë¡œë“œ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œ ì¼ê¸° ìë™ ë¡œë”© ì œê±°
        // loadDiaryForDate();
    </script>
</body>
</html>
